<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#FF8C00">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Somar Promos">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png">
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png">
  
  <title>Somar Express - Env√≠o de Promos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .brand-orange { color: #FF8C00; }
    .bg-brand-orange { background-color: #FF8C00; }
    .brand-black { color: #1A1A1A; }
    .bg-brand-black { background-color: #1A1A1A; }
    
    .loading {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #FFFFFF;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .fade-in { animation: fadeIn 0.4s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .scale-in { animation: scaleIn 0.2s ease-out; }
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .selected-client {
      background: linear-gradient(135deg, #FFF5E6 0%, #FFE8CC 100%);
      border: 2px solid #FF8C00 !important;
    }

    .variable-tag {
      display: inline-block;
      background: #E6F3FF;
      border: 1px solid #4A9EFF;
      color: #1E5BA8;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin: 2px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .variable-tag:hover {
      background: #4A9EFF;
      color: white;
      transform: scale(1.05);
    }

    .status-enviado { background: #D1FAE5; color: #065F46; }
    .status-pendiente { background: #FEF3C7; color: #92400E; }
    .status-error { background: #FEE2E2; color: #991B1B; }

    #messagePreview {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .client-card {
      transition: all 0.2s;
      cursor: pointer;
    }

    .client-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    @media (max-width: 768px) {
      #messagePanel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-height: 70vh;
        border-radius: 24px 24px 0 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
      }
    }

    .progress-bar {
      transition: width 0.3s ease;
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Header -->
  <header class="bg-white sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png" alt="Somar Express" class="w-12 h-12 object-contain">
          <div>
            <h1 class="font-bold text-lg">üì± Env√≠o de Promos</h1>
            <p class="text-xs text-gray-500">Marketing WhatsApp</p>
          </div>
        </div>
        
        <button id="historialBtn" class="p-2 hover:bg-gray-100 rounded-full transition" title="Ver Historial">
          <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Loading Screen -->
  <div id="loading" class="fixed inset-0 bg-gradient-to-br from-orange-500 to-orange-600 flex flex-col justify-center items-center z-50">
    <img src="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871112/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221144_0000_fcsl1b.png" alt="Somar Express" class="w-32 h-32 mb-6 animate-pulse">
    <div class="loading"></div>
    <p class="text-white mt-4 font-semibold">Cargando clientes...</p>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="hidden">
    <!-- Stats Banner -->
    <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white py-4">
      <div class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <p class="text-2xl font-bold" id="totalClientes">0</p>
            <p class="text-xs opacity-90">Total Clientes</p>
          </div>
          <div>
            <p class="text-2xl font-bold" id="clientesSeleccionados">0</p>
            <p class="text-xs opacity-90">Seleccionados</p>
          </div>
          <div>
            <p class="text-2xl font-bold" id="enviosHoy">0</p>
            <p class="text-xs opacity-90">Env√≠os Hoy</p>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto p-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        
        <!-- Left Panel: Client List -->
        <div class="lg:col-span-2 space-y-4">
          
          <!-- Filters -->
          <div class="bg-white rounded-2xl shadow-sm p-4">
            <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
              üîç Filtros
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-semibold mb-2 text-gray-700">Buscar por nombre</label>
                <input type="text" id="searchNombre" placeholder="Nombre del cliente..." class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-brand-orange focus:outline-none transition text-sm">
              </div>
              
              <div>
                <label class="block text-sm font-semibold mb-2 text-gray-700">Ciudad</label>
                <select id="filtroCiudad" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-brand-orange focus:outline-none transition bg-white text-sm">
                  <option value="">üåç Todas las ciudades</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-semibold mb-2 text-gray-700">Colonia/Sector</label>
                <select id="filtroColonia" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-brand-orange focus:outline-none transition bg-white text-sm">
                  <option value="">üèòÔ∏è Todas las colonias</option>
                </select>
              </div>
            </div>

            <!-- Filtro de Pedidos -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
              <div>
                <label class="block text-sm font-semibold mb-2 text-gray-700">üì¶ Filtrar por pedidos</label>
                <select id="filtroPedidosOperador" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-brand-orange focus:outline-none transition bg-white text-sm">
                  <option value="">Sin filtro</option>
                  <option value="igual">Igual a</option>
                  <option value="mayor">Mayor que</option>
                  <option value="menor">Menor que</option>
                  <option value="mayor_igual">Mayor o igual a</option>
                  <option value="menor_igual">Menor o igual a</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-semibold mb-2 text-gray-700">Cantidad</label>
                <input type="number" id="filtroPedidosCantidad" min="0" placeholder="Ej: 5" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-brand-orange focus:outline-none transition text-sm">
              </div>

              <div class="flex items-end">
                <div class="text-xs text-gray-500 px-2">
                  Combina filtros para buscar clientes espec√≠ficos
                </div>
              </div>
            </div>

            <!-- Ordenamiento -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 pt-3 border-t border-gray-200">
              <div>
                <label class="block text-sm font-semibold mb-2 text-gray-700">üîÉ Ordenar por</label>
                <select id="ordenarPor" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-brand-orange focus:outline-none transition bg-white text-sm">
                  <option value="">Sin ordenar</option>
                  <option value="nombre">Nombre (A-Z)</option>
                  <option value="nombre_desc">Nombre (Z-A)</option>
                  <option value="ciudad">Ciudad (A-Z)</option>
                  <option value="ciudad_desc">Ciudad (Z-A)</option>
                  <option value="colonia">Colonia/Sector (A-Z)</option>
                  <option value="colonia_desc">Colonia/Sector (Z-A)</option>
                  <option value="pedidos">Pedidos (Menor a Mayor)</option>
                  <option value="pedidos_desc">Pedidos (Mayor a Menor)</option>
                  <option value="fecha">Fecha Registro (M√°s Antiguos)</option>
                  <option value="fecha_desc">Fecha Registro (M√°s Recientes)</option>
                </select>
              </div>

              <div class="flex items-end">
                <button id="limpiarFiltros" class="w-full bg-gray-200 text-gray-700 py-2 rounded-xl font-semibold hover:bg-gray-300 transition text-sm">
                  üîÑ Limpiar Todo
                </button>
              </div>
            </div>

            <div class="flex gap-2 mt-4">
              <button id="seleccionarTodos" class="flex-1 bg-blue-500 text-white py-2 rounded-xl font-semibold hover:bg-blue-600 transition text-sm">
                ‚úÖ Seleccionar Todos
              </button>
              <button id="limpiarSeleccion" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-xl font-semibold hover:bg-gray-300 transition text-sm">
                ‚ùå Limpiar
              </button>
            </div>
          </div>

          <!-- Client List -->
          <div class="bg-white rounded-2xl shadow-sm p-4">
            <div class="flex justify-between items-center mb-4">
              <h2 class="font-bold text-lg flex items-center gap-2">
                üë• Clientes
                <span id="clientesMostrados" class="text-sm text-gray-500 font-normal">(0)</span>
              </h2>
            </div>
            
            <div id="clientesList" class="space-y-2 max-h-[600px] overflow-y-auto">
              <!-- Clientes se cargan aqu√≠ -->
            </div>
          </div>
        </div>

        <!-- Right Panel: Message Editor -->
        <div id="messagePanel" class="bg-white rounded-2xl shadow-sm p-4 h-fit sticky top-20">
          <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
            ‚úâÔ∏è Mensaje
          </h2>

          <!-- Variables disponibles -->
          <div class="mb-4">
            <p class="text-xs font-semibold text-gray-600 mb-2">Variables disponibles (clic para insertar):</p>
            <div class="flex flex-wrap gap-1">
              <span class="variable-tag" data-var="{ID}">ID</span>
              <span class="variable-tag" data-var="{NOMBRE}">üë§ NOMBRE</span>
              <span class="variable-tag" data-var="{CELULAR}">üì± CELULAR</span>
              <span class="variable-tag" data-var="{CIUDAD}">üåÜ CIUDAD</span>
              <span class="variable-tag" data-var="{COLONIA}">üèòÔ∏è COLONIA</span>
            </div>
          </div>

          <!-- Textarea -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2 text-gray-700">Escribe tu mensaje</label>
            <textarea id="mensajeTexto" rows="6" placeholder="Ej: ¬°Hola {NOMBRE}! Tenemos promociones especiales en {CIUDAD}..." class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition text-sm resize-none"></textarea>
            <p class="text-xs text-gray-500 mt-1">
              <span id="charCount">0</span> caracteres
            </p>
          </div>

          <!-- Upload de imagen -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2 text-gray-700">Imagen (opcional)</label>
            <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:border-brand-orange transition">
              <div id="uploadPlaceholder">
                <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <p class="text-sm text-gray-600">Clic para subir imagen</p>
                <p class="text-xs text-gray-400 mt-1">JPG, PNG (m√°x. 5MB)</p>
              </div>
              <div id="uploadPreview" class="hidden">
                <img id="previewImg" src="" class="max-h-40 mx-auto rounded-lg mb-2">
                <button id="removeImagen" class="text-red-500 text-sm hover:underline">‚ùå Quitar imagen</button>
              </div>
            </div>
            <input type="file" id="imagenPromo" accept="image/*" class="hidden">
          </div>

          <!-- Preview -->
          <div class="mb-4">
            <p class="text-sm font-semibold mb-2 text-gray-700">Vista previa:</p>
            <div class="bg-gray-50 border border-gray-200 rounded-xl p-3 min-h-[80px]">
              <p id="messagePreview" class="text-sm text-gray-700">El mensaje aparecer√° aqu√≠...</p>
            </div>
          </div>

          <!-- Bot√≥n de prueba API -->
          <button id="testApiBtn" class="w-full bg-blue-500 text-white py-2 rounded-xl font-semibold hover:bg-blue-600 transition mb-3 flex items-center justify-center gap-2 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            üß™ Probar Conexi√≥n BuilderBot
          </button>

          <!-- Bot√≥n enviar -->
          <button id="enviarMensajes" disabled class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-xl font-bold hover:from-green-600 hover:to-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            Enviar a <span id="countEnviar">0</span> cliente(s)
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Historial -->
  <div id="historialModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden scale-in">
      <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 flex justify-between items-center">
        <h2 class="font-bold text-lg">üìä Historial de Env√≠os</h2>
        <button id="closeHistorialBtn" class="hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="p-4">
        <!-- Filtros de historial -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">Filtrar por fecha</label>
            <select id="filtroFechaHistorial" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-brand-orange focus:outline-none transition bg-white text-sm">
              <option value="todos">Todos</option>
              <option value="hoy">Hoy</option>
              <option value="semana">Esta semana</option>
              <option value="mes">Este mes</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">Buscar</label>
            <input type="text" id="searchHistorial" placeholder="Buscar en mensajes..." class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-brand-orange focus:outline-none transition text-sm">
          </div>
        </div>

        <!-- Lista de historial -->
        <div id="historialList" class="space-y-3 max-h-[500px] overflow-y-auto">
          <!-- Historial se carga aqu√≠ -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Progreso -->
  <div id="progressModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full scale-in">
      <div class="p-6">
        <h2 class="text-xl font-bold text-center mb-4">üì§ Enviando Mensajes</h2>
        
        <div class="mb-4">
          <div class="flex justify-between text-sm mb-2">
            <span class="font-semibold">Progreso:</span>
            <span><span id="progressCount">0</span> de <span id="progressTotal">0</span></span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
            <div id="progressBar" class="bg-brand-orange h-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>

        <div class="bg-gray-50 rounded-xl p-4 max-h-60 overflow-y-auto mb-4">
          <div id="progressLog" class="text-sm space-y-2">
            <!-- Log de env√≠os -->
          </div>
        </div>

        <button id="closeProgressBtn" disabled class="w-full bg-gray-300 text-gray-600 py-3 rounded-xl font-bold transition">
          ‚è≥ Enviando...
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURACI√ìN
    // ============================================
    
    // ‚ö†Ô∏è IMPORTANTE: Actualiza esta URL despu√©s de implementar CODE-PROMOS.gs
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzF3Zcz1cEIQ7oJqCkZUuOreoDJq8TiLJdd0VqZ4md4KIxHBy7eMZ8lDqAU3gLP0hdJkQ/exec';
    
    // BuilderBot API Config
    const BUILDERBOT_API = 'https://app.builderbot.cloud/api/v2/72940379-becf-4dec-8233-2d4bd1de6e1c/messages';
    const BUILDERBOT_KEY = 'bb-32307901-f2b8-4ac2-a849-68a02b24f43f';
    
    // ‚è±Ô∏è DELAY ENTRE ENV√çOS (en segundos)
    // Recomendado: 10-15 segundos para evitar bloqueo de WhatsApp
    // M√≠nimo: 5 segundos
    // M√°ximo: 30 segundos
    const DELAY_ENTRE_ENVIOS = 10; // segundos
    
    // Cloudinary Config
    const CLOUDINARY_CLOUD_NAME = 'drkaxsziu';
    const CLOUDINARY_UPLOAD_PRESET = 'PROMOS_SOMAR';
    
    // ============================================
    // VARIABLES GLOBALES
    // ============================================

    const appData = {
      clientes: [],
      clientesFiltrados: [],
      clientesSeleccionados: new Set(),
      historial: [],
      imagenUrl: null,
      filtros: {
        ciudades: [],
        colonias: []
      }
    };

    // ============================================
    // INICIALIZACI√ìN
    // ============================================

    window.addEventListener('DOMContentLoaded', async () => {
      await cargarClientes();
      cargarHistorialLocal();
      setupEventListeners();
      actualizarEstadisticas();
    });

    // ============================================
    // CARGAR DATOS
    // ============================================

    async function cargarClientes() {
      try {
        console.log('üìã Cargando clientes...');
        
        const url = `${SCRIPT_URL}?action=getClientes`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('üì• Respuesta recibida:', result);
        
        if (result.success) {
          appData.clientes = result.clientes || [];
          appData.clientesFiltrados = [...appData.clientes];
          
          poblarFiltros();
          renderizarClientes();
          
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('mainContent').classList.remove('hidden');
          
          actualizarEstadisticas();
          
          console.log(`‚úÖ ${appData.clientes.length} clientes cargados`);
        } else {
          throw new Error(result.error || 'Error desconocido');
        }
      } catch (error) {
        console.error('‚ùå Error cargando clientes:', error);
        document.getElementById('loading').innerHTML = `
          <div class="text-white text-center p-8">
            <p class="text-2xl mb-4">‚ùå Error al cargar</p>
            <p class="mb-4">${error.message}</p>
            <button onclick="location.reload()" class="bg-white text-orange-600 px-6 py-2 rounded-lg font-bold">
              Reintentar
            </button>
          </div>
        `;
      }
    }

    function poblarFiltros() {
      const ciudades = [...new Set(appData.clientes.map(c => c.CIUDAD).filter(Boolean))].sort();
      const colonias = [...new Set(appData.clientes.map(c => c['COLONIA/SECTOR']).filter(Boolean))].sort();
      
      const selectCiudad = document.getElementById('filtroCiudad');
      const selectColonia = document.getElementById('filtroColonia');
      
      ciudades.forEach(ciudad => {
        const option = document.createElement('option');
        option.value = ciudad;
        option.textContent = ciudad;
        selectCiudad.appendChild(option);
      });
      
      colonias.forEach(colonia => {
        const option = document.createElement('option');
        option.value = colonia;
        option.textContent = colonia;
        selectColonia.appendChild(option);
      });
    }

    function cargarHistorialLocal() {
      const historialGuardado = localStorage.getItem('somarPromoHistorial');
      if (historialGuardado) {
        try {
          appData.historial = JSON.parse(historialGuardado);
        } catch (error) {
          appData.historial = [];
        }
      }
    }

    // ============================================
    // FILTROS Y SELECCI√ìN
    // ============================================

    function aplicarFiltros() {
      const searchNombre = document.getElementById('searchNombre').value.toLowerCase();
      const filtroCiudad = document.getElementById('filtroCiudad').value;
      const filtroColonia = document.getElementById('filtroColonia').value;
      
      // Filtro de pedidos
      const pedidosOperador = document.getElementById('filtroPedidosOperador').value;
      const pedidosCantidad = parseInt(document.getElementById('filtroPedidosCantidad').value) || 0;
      
      appData.clientesFiltrados = appData.clientes.filter(cliente => {
        const matchNombre = !searchNombre || cliente.NOMBRE.toLowerCase().includes(searchNombre);
        const matchCiudad = !filtroCiudad || cliente.CIUDAD === filtroCiudad;
        const matchColonia = !filtroColonia || cliente['COLONIA/SECTOR'] === filtroColonia;
        
        // Filtro de pedidos
        let matchPedidos = true;
        if (pedidosOperador && pedidosCantidad >= 0) {
          const pedidos = cliente.PEDIDOS || 0;
          
          switch (pedidosOperador) {
            case 'igual':
              matchPedidos = pedidos === pedidosCantidad;
              break;
            case 'mayor':
              matchPedidos = pedidos > pedidosCantidad;
              break;
            case 'menor':
              matchPedidos = pedidos < pedidosCantidad;
              break;
            case 'mayor_igual':
              matchPedidos = pedidos >= pedidosCantidad;
              break;
            case 'menor_igual':
              matchPedidos = pedidos <= pedidosCantidad;
              break;
          }
        }
        
        return matchNombre && matchCiudad && matchColonia && matchPedidos;
      });
      
      // Aplicar ordenamiento
      aplicarOrdenamiento();
      
      renderizarClientes();
      actualizarEstadisticas();
    }

    function aplicarOrdenamiento() {
      const ordenarPor = document.getElementById('ordenarPor').value;
      
      if (!ordenarPor) return;
      
      appData.clientesFiltrados.sort((a, b) => {
        switch (ordenarPor) {
          case 'nombre':
            return (a.NOMBRE || '').localeCompare(b.NOMBRE || '');
          case 'nombre_desc':
            return (b.NOMBRE || '').localeCompare(a.NOMBRE || '');
            
          case 'ciudad':
            return (a.CIUDAD || '').localeCompare(b.CIUDAD || '');
          case 'ciudad_desc':
            return (b.CIUDAD || '').localeCompare(a.CIUDAD || '');
            
          case 'colonia':
            return (a['COLONIA/SECTOR'] || '').localeCompare(b['COLONIA/SECTOR'] || '');
          case 'colonia_desc':
            return (b['COLONIA/SECTOR'] || '').localeCompare(a['COLONIA/SECTOR'] || '');
            
          case 'pedidos':
            return (a.PEDIDOS || 0) - (b.PEDIDOS || 0);
          case 'pedidos_desc':
            return (b.PEDIDOS || 0) - (a.PEDIDOS || 0);
            
          case 'fecha':
            const fechaA = a.FECHA_REGISTRO ? new Date(a.FECHA_REGISTRO).getTime() : 0;
            const fechaB = b.FECHA_REGISTRO ? new Date(b.FECHA_REGISTRO).getTime() : 0;
            return fechaA - fechaB;
          case 'fecha_desc':
            const fechaA2 = a.FECHA_REGISTRO ? new Date(a.FECHA_REGISTRO).getTime() : 0;
            const fechaB2 = b.FECHA_REGISTRO ? new Date(b.FECHA_REGISTRO).getTime() : 0;
            return fechaB2 - fechaA2;
            
          default:
            return 0;
        }
      });
    }

    function limpiarTodosFiltros() {
      document.getElementById('searchNombre').value = '';
      document.getElementById('filtroCiudad').value = '';
      document.getElementById('filtroColonia').value = '';
      document.getElementById('filtroPedidosOperador').value = '';
      document.getElementById('filtroPedidosCantidad').value = '';
      document.getElementById('ordenarPor').value = '';
      aplicarFiltros();
    }

    function toggleCliente(clienteId) {
      const id = parseInt(clienteId) || clienteId;
      
      if (appData.clientesSeleccionados.has(id)) {
        appData.clientesSeleccionados.delete(id);
      } else {
        appData.clientesSeleccionados.add(id);
      }
      
      renderizarClientes();
      actualizarEstadisticas();
      actualizarBotonEnviar();
    }

    function seleccionarTodos() {
      appData.clientesFiltrados.forEach(c => {
        appData.clientesSeleccionados.add(c.ID);
      });
      renderizarClientes();
      actualizarEstadisticas();
      actualizarBotonEnviar();
    }

    function limpiarSeleccion() {
      appData.clientesSeleccionados.clear();
      renderizarClientes();
      actualizarEstadisticas();
      actualizarBotonEnviar();
    }

    function renderizarClientes() {
      const container = document.getElementById('clientesList');
      
      if (appData.clientesFiltrados.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <p class="text-4xl mb-2">üîç</p>
            <p class="font-semibold">No se encontraron clientes</p>
            <p class="text-sm">Intenta ajustar los filtros</p>
          </div>
        `;
        document.getElementById('clientesMostrados').textContent = '(0)';
        return;
      }
      
      container.innerHTML = appData.clientesFiltrados.map(cliente => {
        const isSelected = appData.clientesSeleccionados.has(cliente.ID);
        const pedidos = cliente.PEDIDOS || 0;
        
        // Color del badge seg√∫n cantidad de pedidos
        let badgeClass = 'bg-gray-100 text-gray-600';
        if (pedidos >= 10) badgeClass = 'bg-green-100 text-green-700';
        else if (pedidos >= 5) badgeClass = 'bg-blue-100 text-blue-700';
        else if (pedidos >= 1) badgeClass = 'bg-yellow-100 text-yellow-700';
        
        return `
          <div class="client-card border-2 ${isSelected ? 'selected-client' : 'border-gray-200'} rounded-xl p-3" onclick="toggleCliente('${cliente.ID}')">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <input type="checkbox" ${isSelected ? 'checked' : ''} class="w-4 h-4 accent-orange-500" onclick="event.stopPropagation()">
                  <p class="font-bold text-sm">${cliente.NOMBRE || 'Sin nombre'}</p>
                </div>
                <p class="text-xs text-gray-600">üì± ${cliente.CELULAR}</p>
                <p class="text-xs text-gray-500">üìç ${cliente.CIUDAD} - ${cliente['COLONIA/SECTOR'] || 'N/A'}</p>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-xs px-2 py-0.5 ${badgeClass} rounded-full font-semibold">
                    üì¶ ${pedidos} pedido${pedidos !== 1 ? 's' : ''}
                  </span>
                </div>
              </div>
              
              <span class="text-xs px-2 py-1 bg-gray-100 rounded-full font-semibold text-gray-600">
                #${cliente.ID}
              </span>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('clientesMostrados').textContent = `(${appData.clientesFiltrados.length})`;
    }

    // ============================================
    // FILTROS
    // ============================================

    function aplicarFiltros() {
      const nombreBusqueda = document.getElementById('searchNombre').value.toLowerCase();
      const ciudadFiltro = document.getElementById('filtroCiudad').value;
      const coloniaFiltro = document.getElementById('filtroColonia').value;
      
      appData.clientesFiltrados = appData.clientes.filter(cliente => {
        const matchNombre = !nombreBusqueda || (cliente.NOMBRE || '').toLowerCase().includes(nombreBusqueda);
        const matchCiudad = !ciudadFiltro || cliente.CIUDAD === ciudadFiltro;
        const matchColonia = !coloniaFiltro || cliente['COLONIA/SECTOR'] === coloniaFiltro;
        
        return matchNombre && matchCiudad && matchColonia;
      });
      
      renderizarClientes();
    }

    // ============================================
    // SELECCI√ìN DE CLIENTES
    // ============================================

    function toggleCliente(clienteId) {
      if (appData.clientesSeleccionados.has(clienteId)) {
        appData.clientesSeleccionados.delete(clienteId);
      } else {
        appData.clientesSeleccionados.add(clienteId);
      }
      
      renderizarClientes();
      actualizarEstadisticas();
      actualizarBotonEnviar();
    }

    // ============================================
    // MENSAJE
    // ============================================

    function actualizarPreview() {
      const mensaje = document.getElementById('mensajeTexto').value;
      
      if (!mensaje) {
        document.getElementById('messagePreview').textContent = 'El mensaje aparecer√° aqu√≠...';
        return;
      }
      
      // Tomar el primer cliente seleccionado para preview
      const primeraSeleccion = Array.from(appData.clientesSeleccionados)[0];
      
      if (primeraSeleccion) {
        const cliente = appData.clientes.find(c => c.ID === primeraSeleccion);
        if (cliente) {
          let preview = mensaje;
          
          // Reemplazar variables con llaves simples
          preview = preview.replace(/\{ID\}/g, cliente.ID || '');
          preview = preview.replace(/\{NOMBRE\}/g, cliente.NOMBRE || '');
          preview = preview.replace(/\{CELULAR\}/g, cliente.CELULAR || '');
          preview = preview.replace(/\{CIUDAD\}/g, cliente.CIUDAD || '');
          preview = preview.replace(/\{COLONIA\}/g, cliente['COLONIA/SECTOR'] || '');
          
          document.getElementById('messagePreview').textContent = preview;
          return;
        }
      }
      
      // Si no hay cliente seleccionado, mostrar con variables
      document.getElementById('messagePreview').textContent = mensaje;
    }

    // ============================================
    // PRUEBA DE API BUILDERBOT
    // ============================================

    async function probarApiBuilderBot() {
      const btn = document.getElementById('testApiBtn');
      const originalHtml = btn.innerHTML;
      
      btn.disabled = true;
      btn.innerHTML = '<div class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> Probando...';
      
      try {
        console.log('üß™ === PRUEBA DE API BUILDERBOT ===');
        console.log('API:', BUILDERBOT_API);
        console.log('KEY:', BUILDERBOT_KEY.substring(0, 10) + '...');
        
        // Mensaje de prueba
        const testPayload = {
          messages: {
            content: "üß™ Prueba de conexi√≥n BuilderBot - Sistema de Promos Somar Express"
          },
          number: "50432032345", // N√∫mero de prueba gen√©rico
          checkIfExists: false
        };
        
        console.log('üì¶ Payload:', JSON.stringify(testPayload, null, 2));
        
        const response = await fetch(BUILDERBOT_API, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-builderbot': BUILDERBOT_KEY
          },
          body: JSON.stringify(testPayload)
        });
        
        const responseText = await response.text();
        
        console.log('üì• Status:', response.status);
        console.log('üì• Response:', responseText);
        
        if (response.ok || response.status === 200 || response.status === 201) {
          btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
          btn.classList.add('bg-green-500');
          btn.innerHTML = '‚úÖ Conexi√≥n Exitosa!';
          
          alert(`‚úÖ ¬°Conexi√≥n Exitosa con BuilderBot!\n\nStatus: ${response.status}\nRespuesta: ${responseText}\n\n‚ú® El sistema est√° listo para enviar mensajes.`);
          
          setTimeout(() => {
            btn.classList.remove('bg-green-500');
            btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
          }, 3000);
        } else {
          throw new Error(`Error ${response.status}: ${responseText}`);
        }
      } catch (error) {
        console.error('‚ùå Error en prueba:', error);
        
        btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        btn.classList.add('bg-red-500');
        btn.innerHTML = '‚ùå Error de Conexi√≥n';
        
        alert(`‚ùå Error de Conexi√≥n con BuilderBot\n\n${error.message}\n\nRevisa:\n1. API URL correcta\n2. API KEY correcta\n3. Console (F12) para m√°s detalles`);
        
        setTimeout(() => {
          btn.classList.remove('bg-red-500');
          btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
          btn.innerHTML = originalHtml;
          btn.disabled = false;
        }, 3000);
      }
    }

    // ============================================
    // ENV√çO DE MENSAJES
    // ============================================

    async function enviarMensajesMasivos() {
      const mensaje = document.getElementById('mensajeTexto').value.trim();
      
      if (!mensaje) {
        alert('‚ö†Ô∏è Debes escribir un mensaje');
        return;
      }
      
      if (appData.clientesSeleccionados.size === 0) {
        alert('‚ö†Ô∏è Debes seleccionar al menos un cliente');
        return;
      }
      
      // Confirmar
      const confirmar = confirm(`¬øEnviar mensaje a ${appData.clientesSeleccionados.size} cliente(s)?`);
      if (!confirmar) return;
      
      // Obtener clientes seleccionados
      const clientesAEnviar = appData.clientes.filter(c => 
        appData.clientesSeleccionados.has(c.ID)
      );
      
      // Mostrar modal de progreso
      document.getElementById('progressModal').classList.remove('hidden');
      document.getElementById('progressCount').textContent = '0';
      document.getElementById('progressTotal').textContent = clientesAEnviar.length;
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('progressLog').innerHTML = `
        <p class="text-gray-500 text-center text-sm">Iniciando env√≠o...</p>
        <p class="text-blue-600 text-center text-xs mt-2">‚è±Ô∏è Delay de ${DELAY_ENTRE_ENVIOS}s entre cada env√≠o</p>
        <p class="text-gray-400 text-center text-xs">(Para evitar bloqueo de WhatsApp)</p>
      `;
      document.getElementById('closeProgressBtn').disabled = true;
      
      let exitosos = 0;
      let fallidos = 0;
      const detalles = [];
      
      for (let i = 0; i < clientesAEnviar.length; i++) {
        const cliente = clientesAEnviar[i];
        
        // Personalizar mensaje
        let mensajePersonalizado = mensaje
          .replace(/\{NOMBRE\}/g, cliente.NOMBRE || '')
          .replace(/\{CIUDAD\}/g, cliente.CIUDAD || '')
          .replace(/\{COLONIA\}/g, cliente['COLONIA/SECTOR'] || '');
        
        // Enviar a BuilderBot
        try {
          const resultado = await enviarWhatsApp(cliente.CELULAR, mensajePersonalizado, appData.imagenUrl);
          
          if (resultado.success) {
            exitosos++;
            detalles.push({
              cliente: cliente.NOMBRE,
              estado: 'exitoso',
              mensaje: 'Enviado correctamente'
            });
            
            // Log en el modal
            const logEntry = document.createElement('div');
            logEntry.className = 'flex items-start gap-2 text-sm';
            logEntry.innerHTML = `
              <span class="text-green-600">‚úÖ</span>
              <span class="text-gray-700">${cliente.NOMBRE}</span>
            `;
            document.getElementById('progressLog').appendChild(logEntry);
          } else {
            throw new Error(resultado.error || 'Error desconocido');
          }
        } catch (error) {
          fallidos++;
          detalles.push({
            cliente: cliente.NOMBRE,
            estado: 'fallido',
            mensaje: error.message
          });
          
          // Log en el modal
          const logEntry = document.createElement('div');
          logEntry.className = 'flex items-start gap-2 text-sm';
          logEntry.innerHTML = `
            <span class="text-red-600">‚ùå</span>
            <span class="text-gray-700">${cliente.NOMBRE}</span>
          `;
          document.getElementById('progressLog').appendChild(logEntry);
        }
        
        // Actualizar progreso
        const progreso = ((i + 1) / clientesAEnviar.length) * 100;
        document.getElementById('progressBar').style.width = progreso + '%';
        document.getElementById('progressCount').textContent = i + 1;
        
        // Scroll al final del log
        document.getElementById('progressLog').scrollTop = document.getElementById('progressLog').scrollHeight;
        
        // Delay entre env√≠os (10 segundos para evitar bloqueo de WhatsApp)
        // Solo hacer delay si NO es el √∫ltimo cliente
        if (i < clientesAEnviar.length - 1) {
          // Mostrar contador de delay
          const delaySeconds = DELAY_ENTRE_ENVIOS;
          for (let countdown = delaySeconds; countdown > 0; countdown--) {
            const delayMsg = document.createElement('div');
            delayMsg.className = 'text-xs text-gray-500 text-center';
            delayMsg.textContent = `‚è≥ Esperando ${countdown}s antes del siguiente env√≠o...`;
            delayMsg.id = 'countdown-msg';
            
            // Remover mensaje anterior si existe
            const oldMsg = document.getElementById('countdown-msg');
            if (oldMsg) oldMsg.remove();
            
            document.getElementById('progressLog').appendChild(delayMsg);
            document.getElementById('progressLog').scrollTop = document.getElementById('progressLog').scrollHeight;
            
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
          
          // Remover el mensaje de countdown
          const finalMsg = document.getElementById('countdown-msg');
          if (finalMsg) finalMsg.remove();
        }
      }
      
      // Guardar en historial
      guardarEnHistorial({
        fecha: new Date().toISOString(),
        mensaje: mensaje,
        imagenUrl: appData.imagenUrl,
        totalDestinatarios: clientesAEnviar.length,
        exitosos: exitosos,
        fallidos: fallidos,
        clientes: clientesAEnviar.map(c => ({
          ID: c.ID,
          NOMBRE: c.NOMBRE,
          CELULAR: c.CELULAR
        }))
      });
      
      // Habilitar bot√≥n cerrar
      document.getElementById('closeProgressBtn').disabled = false;
      document.getElementById('closeProgressBtn').textContent = '‚úÖ Completado - Cerrar';
      document.getElementById('closeProgressBtn').classList.remove('bg-gray-300', 'text-gray-600');
      document.getElementById('closeProgressBtn').classList.add('bg-brand-orange', 'text-white', 'hover:bg-orange-600');
      
      // Limpiar formulario y selecci√≥n
      appData.clientesSeleccionados.clear();
      renderizarClientes();
      actualizarEstadisticas();
      actualizarBotonEnviar();
    }

    async function enviarWhatsApp(celular, mensaje, imagenUrl = null) {
      try {
        // Asegurar que el n√∫mero tenga el formato correcto
        // Si no tiene c√≥digo de pa√≠s, agregar 504 (Honduras)
        let numeroFormateado = celular.toString().replace(/\D/g, ''); // Solo n√∫meros
        
        // Si el n√∫mero es de 8 d√≠gitos, agregar c√≥digo de pa√≠s 504
        if (numeroFormateado.length === 8) {
          numeroFormateado = '504' + numeroFormateado;
        }
        
        const payload = {
          messages: {
            content: mensaje
          },
          number: numeroFormateado,
          checkIfExists: false
        };
        
        // Solo agregar mediaUrl si existe
        if (imagenUrl && imagenUrl.trim() !== '') {
          payload.messages.mediaUrl = imagenUrl;
        }
        
        console.log('üì§ Enviando a:', numeroFormateado);
        console.log('üìù Mensaje:', mensaje.substring(0, 50) + '...');
        
        const response = await fetch(BUILDERBOT_API, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-builderbot': BUILDERBOT_KEY
          },
          body: JSON.stringify(payload)
        });
        
        const responseText = await response.text();
        
        console.log('üì• Status:', response.status);
        console.log('üì• Response:', responseText);
        
        if (response.ok || response.status === 200 || response.status === 201) {
          console.log('‚úÖ Mensaje enviado correctamente');
          return { success: true };
        } else {
          console.error('‚ùå Error del servidor:', responseText);
          throw new Error(`BuilderBot error: ${responseText}`);
        }
      } catch (error) {
        console.error('‚ùå Error en enviarWhatsApp:', error);
        return { success: false, error: error.message };
      }
    }

    function guardarEnHistorial(entrada) {
      entrada.id = Date.now();
      appData.historial.unshift(entrada);
      
      // Guardar en localStorage
      try {
        localStorage.setItem('somarPromoHistorial', JSON.stringify(appData.historial));
      } catch (error) {
        console.error('Error guardando historial:', error);
      }
    }

    // ============================================
    // SUBIR IMAGEN
    // ============================================

    async function subirImagenCloudinary(file) {
      try {
        if (file.size > 5 * 1024 * 1024) {
          throw new Error('La imagen es muy grande. M√°ximo 5MB');
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
        formData.append('folder', 'PROMOS_SOMAR');
        
        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
          {
            method: 'POST',
            body: formData
          }
        );
        
        const data = await response.json();
        
        if (data.secure_url) {
          return { success: true, url: data.secure_url };
        } else {
          throw new Error('Error al subir imagen');
        }
      } catch (error) {
        console.error('Error subiendo imagen:', error);
        return { success: false, error: error.message };
      }
    }

    // ============================================
    // HISTORIAL
    // ============================================

    function renderizarHistorial() {
      const container = document.getElementById('historialList');
      const filtroFecha = document.getElementById('filtroFechaHistorial').value;
      const busqueda = document.getElementById('searchHistorial').value.toLowerCase();
      
      let historialFiltrado = appData.historial;
      
      // Filtrar por fecha
      if (filtroFecha !== 'todos') {
        const hoy = new Date();
        historialFiltrado = historialFiltrado.filter(entrada => {
          const fechaEntrada = new Date(entrada.fecha);
          
          if (filtroFecha === 'hoy') {
            return fechaEntrada.toDateString() === hoy.toDateString();
          } else if (filtroFecha === 'semana') {
            const unaSemanaAtras = new Date(hoy.getTime() - 7 * 24 * 60 * 60 * 1000);
            return fechaEntrada >= unaSemanaAtras;
          } else if (filtroFecha === 'mes') {
            return fechaEntrada.getMonth() === hoy.getMonth() && 
                   fechaEntrada.getFullYear() === hoy.getFullYear();
          }
        });
      }
      
      // Filtrar por b√∫squeda
      if (busqueda) {
        historialFiltrado = historialFiltrado.filter(entrada =>
          entrada.mensaje.toLowerCase().includes(busqueda)
        );
      }
      
      if (historialFiltrado.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <p class="text-4xl mb-2">üì≠</p>
            <p class="font-semibold">No hay env√≠os registrados</p>
            <p class="text-sm mt-2">Los env√≠os que realices aparecer√°n aqu√≠</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = historialFiltrado.map(entrada => {
        const fecha = new Date(entrada.fecha);
        const fechaStr = fecha.toLocaleDateString('es-GT', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        return `
          <div class="bg-white border-2 border-gray-200 rounded-xl p-4 hover:border-brand-orange transition">
            <div class="flex justify-between items-start mb-3">
              <div>
                <p class="text-xs text-gray-500">${fechaStr}</p>
                <p class="font-bold text-sm mt-1">üì§ ${entrada.clientesCount} destinatario(s)</p>
              </div>
              <div class="flex gap-2">
                <span class="status-enviado px-3 py-1 rounded-full text-xs font-bold">
                  ‚úÖ ${entrada.exitosos}
                </span>
                ${entrada.fallidos > 0 ? `
                  <span class="status-error px-3 py-1 rounded-full text-xs font-bold">
                    ‚ùå ${entrada.fallidos}
                  </span>
                ` : ''}
              </div>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-3 mb-3">
              <p class="text-sm text-gray-800 whitespace-pre-wrap">${entrada.mensaje}</p>
            </div>
            
            ${entrada.imagenUrl ? `
              <div class="mb-3">
                <img src="${entrada.imagenUrl}" class="rounded-lg max-h-32 object-cover">
              </div>
            ` : ''}
            
            <details class="text-xs">
              <summary class="cursor-pointer text-brand-orange font-semibold hover:underline">
                Ver destinatarios (${entrada.clientes.length})
              </summary>
              <div class="mt-2 space-y-1">
                ${entrada.clientes.map(c => `
                  <p class="text-gray-600">‚Ä¢ ${c.NOMBRE} - ${c.CELULAR}</p>
                `).join('')}
              </div>
            </details>
          </div>
        `;
      }).join('');
    }

    // ============================================
    // ESTAD√çSTICAS
    // ============================================

    function actualizarEstadisticas() {
      document.getElementById('totalClientes').textContent = appData.clientes.length;
      document.getElementById('clientesSeleccionados').textContent = appData.clientesSeleccionados.size;
      
      // Env√≠os hoy - con manejo seguro de fechas
      try {
        const hoy = new Date();
        const hoyStr = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
        
        const enviosHoy = appData.historial.filter(h => {
          if (!h.fecha) return false;
          
          try {
            const fechaEntrada = new Date(h.fecha);
            if (isNaN(fechaEntrada.getTime())) return false;
            
            const fechaStr = `${fechaEntrada.getFullYear()}-${String(fechaEntrada.getMonth() + 1).padStart(2, '0')}-${String(fechaEntrada.getDate()).padStart(2, '0')}`;
            return fechaStr === hoyStr;
          } catch (e) {
            return false;
          }
        }).reduce((sum, h) => sum + (h.exitosos || 0), 0);
        
        document.getElementById('enviosHoy').textContent = enviosHoy;
      } catch (error) {
        console.error('Error calculando env√≠os hoy:', error);
        document.getElementById('enviosHoy').textContent = '0';
      }
    }

    function actualizarBotonEnviar() {
      const btn = document.getElementById('enviarMensajes');
      const count = appData.clientesSeleccionados.size;
      
      document.getElementById('countEnviar').textContent = count;
      btn.disabled = count === 0;
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================

    function setupEventListeners() {
      // Filtros
      document.getElementById('searchNombre').addEventListener('input', aplicarFiltros);
      document.getElementById('filtroCiudad').addEventListener('change', aplicarFiltros);
      document.getElementById('filtroColonia').addEventListener('change', aplicarFiltros);
      document.getElementById('filtroPedidosOperador').addEventListener('change', aplicarFiltros);
      document.getElementById('filtroPedidosCantidad').addEventListener('input', aplicarFiltros);
      document.getElementById('ordenarPor').addEventListener('change', aplicarFiltros);
      document.getElementById('limpiarFiltros').addEventListener('click', limpiarTodosFiltros);
      
      // Selecci√≥n
      document.getElementById('seleccionarTodos').addEventListener('click', seleccionarTodos);
      document.getElementById('limpiarSeleccion').addEventListener('click', limpiarSeleccion);
      
      // Test API BuilderBot
      document.getElementById('testApiBtn').addEventListener('click', probarApiBuilderBot);
      
      // Mensaje
      const mensajeTexto = document.getElementById('mensajeTexto');
      mensajeTexto.addEventListener('input', () => {
        document.getElementById('charCount').textContent = mensajeTexto.value.length;
        actualizarPreview();
      });
      
      // Variables
      document.querySelectorAll('.variable-tag').forEach(tag => {
        tag.addEventListener('click', () => {
          const variable = tag.dataset.var;
          const textarea = document.getElementById('mensajeTexto');
          const cursorPos = textarea.selectionStart;
          const textBefore = textarea.value.substring(0, cursorPos);
          const textAfter = textarea.value.substring(cursorPos);
          
          textarea.value = textBefore + variable + textAfter;
          textarea.focus();
          textarea.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);
          
          document.getElementById('charCount').textContent = textarea.value.length;
          actualizarPreview();
        });
      });
      
      // Imagen
      document.getElementById('uploadArea').addEventListener('click', () => {
        document.getElementById('imagenPromo').click();
      });
      
      document.getElementById('imagenPromo').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.size > 5 * 1024 * 1024) {
          alert('‚ö†Ô∏è Imagen muy grande. M√°ximo 5MB');
          e.target.value = '';
          return;
        }
        
        // Preview local
        const reader = new FileReader();
        reader.onload = (event) => {
          document.getElementById('previewImg').src = event.target.result;
          document.getElementById('uploadPlaceholder').classList.add('hidden');
          document.getElementById('uploadPreview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
        
        // Subir a Cloudinary
        const resultado = await subirImagenCloudinary(file);
        if (resultado.success) {
          appData.imagenUrl = resultado.url;
          console.log('‚úÖ Imagen subida:', resultado.url);
        } else {
          alert('‚ö†Ô∏è Error al subir imagen: ' + resultado.error);
          e.target.value = '';
          document.getElementById('uploadPlaceholder').classList.remove('hidden');
          document.getElementById('uploadPreview').classList.add('hidden');
        }
      });
      
      document.getElementById('removeImagen').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('imagenPromo').value = '';
        document.getElementById('uploadPlaceholder').classList.remove('hidden');
        document.getElementById('uploadPreview').classList.add('hidden');
        appData.imagenUrl = null;
      });
      
      // Enviar
      document.getElementById('enviarMensajes').addEventListener('click', enviarMensajesMasivos);
      
      // Historial
      document.getElementById('historialBtn').addEventListener('click', () => {
        document.getElementById('historialModal').classList.remove('hidden');
        renderizarHistorial();
      });
      
      document.getElementById('closeHistorialBtn').addEventListener('click', () => {
        document.getElementById('historialModal').classList.add('hidden');
      });
      
      document.getElementById('filtroFechaHistorial').addEventListener('change', renderizarHistorial);
      document.getElementById('searchHistorial').addEventListener('input', renderizarHistorial);
      
      // Progreso
      document.getElementById('closeProgressBtn').addEventListener('click', () => {
        document.getElementById('progressModal').classList.add('hidden');
        location.reload();
      });
    }
  </script>
</body>
</html>
